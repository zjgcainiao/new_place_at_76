{% extends 'homepageapp/10_homepageapp_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block content1-main %}
<style>
    /* custom styles on shops/vehicle_search_product */
    /* .nav-tabs {
    border-bottom: 2px solid #dee2e6;
    } */

    .nav-tabs .nav-link {
    border: 1px solid transparent;
    border-top-left-radius: 0.25rem;
    border-top-right-radius: 0.25rem;
    background: #f8f9fa; /* Light grey background */
    margin-right: 2px;
    }

    .nav-tabs .nav-link.active {
    color: #495057;
    background-color: #fff;
    border-color: #dee2e6 #dee2e6 #fff;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),
                0 2px 4px -1px rgba(0,0,0,0.06); /* Soft shadow for active tab */
    }

    .tab-content > .tab-pane {
    border: 1px solid #dee2e6;
    border-top: none; /* Hide top border */
    background: linear-gradient(145deg, #ffffff, #e6e6e6);
    padding: 15px;
    box-shadow: inset 20px 20px 60px #bebebe,
                inset -20px -20px 60px #ffffff; /* Inward shadows for a matte look */
    }

    /* Mobile friendly adjustments */
    @media (max-width: 768px) {
    .nav-tabs .nav-link {
        padding: 0.5rem 1rem; /* Larger tap targets for mobile */
    }

    .tab-content > .tab-pane {
        padding: 10px;
    }
    }

</style>
    <div class="container pt-5 my-5">
        <ul class="nav nav-tabs" id="searchType" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="byPlate-tab" data-bs-toggle="tab" 
                type="button" data-bs-target="#byPlate" role="tab" aria-controls="byPlate" aria-selected="true">By Plate</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="byVIN-tab" data-bs-toggle="tab" 
                type="button" data-bs-target="#byVIN" role="tab" aria-controls="byVIN" aria-selected="false">By VIN</button>
            </li>
        </ul>
        <div class="tab-content" id="searchTypeContent">
            <div class="tab-pane fade show active" id="byPlate" role="tabpanel" aria-labelledby="byPlate-tab">
                <!-- By Plate Form -->
                <!-- <form id="PlateSearchForm" action="{% url 'shops:search_by_vin_or_plate' %}" method="post"> -->

               
                    {% crispy plate_form %}
                    <!-- <button type="submit" name="plate-search" 
                    id="plate-search-button"
                    class="btn btn-outline-secondary">Search</button> -->
                <!-- </form> -->
            </div>
            <div class="tab-pane fade" id="byVIN" role="tabpanel" aria-labelledby="byVIN-tab">

                <!-- By VIN Form -->


                    {% crispy vin_form  vin_form.helper %}
     
            </div>
            <!-- end of the Vin Search Form  -->
        </div>
        <!-- end of form tab-cotent -->
    </div>
    <!-- end of container  -->
    <!-- export to pdf button  -->
    <div class="container mt-1">
        <div class="row">
            <div class="col">
                <button id="exportPdfButtonClientSide" class="btn btn-outline-primary btn-sm" >Export to PDF via client-side</button>
            </div>
            <div class="col">
                    <button id="exportPdfBackend" class="btn btn-outline-dark btn-sm" href="{% url 'shops:export_vin_data_to_pdf' %}">Export to PDF via server-side</button>
            </div>

        
        </div>
    </div>
    <!-- end of button container  -->


    <!-- vinData Display  -->
    <div id="vinDataDisplay" class="container mt-3">

    </div>

    <!-- search result container  -->
    <div class="container my-4">
        <div id="searchResults">
            {% if vehicle %}
                <!-- Basic Information Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">{{ vehicle.name }}</h5>
                        <p class="card-text">Details: {{ vehicle.details }}</p>
                    </div>
                </div>

                <!-- Premium Content -->
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted">Premium content available</div>
                            <a href="{% url 'shops:payment_checkout'%}" class="btn btn-primary">Purchase to view</a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Include the libraries -->
<!-- <script src="https://unpkg.com/jspdf@latest/dist/jspdf.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script> -->
<!-- new vendor html to image js -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js" integrity="sha512-7tWCgq9tTYS/QkGVyKrtLpqAoMV9XIUxoou+sPUypsaZx56cYR/qio84fPK9EvJJtKvJEwt7vkn6je5UVzGevw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    // Once the document is loaded, you can use jsPDF and html2canvas
    const exportPdfButton = document.getElementById('exportPdfButtonClientSide');
    
    // First, we would retrieve the text contents of each cell in the table
    function parseTable(tableSelector) {
    const table = document.querySelector(tableSelector);
    const rows = Array.from(table.rows);
    return rows.map(row => 
        Array.from(row.cells).map(cell => cell.innerText)
    );
    }

    exportPdfButton.addEventListener('click', function() {
        // Ensure 'content' points to the existing table you want to capture
        var content = document.querySelector('#vinDataDisplay .table');
        if (!content) {
            console.error('Element `content` to capture not found');
            return;
        }

        // Check if the content exists and is part of the document
        if (typeof html2canvas == 'function') {
            html2canvas(content, { scale: 2 }).then(canvas => {
                var imgData = canvas.toDataURL('image/jpeg', 0.7);
                var pdf;
                if (window.jspdf && window.jspdf.jsPDF) {
                    pdf = new window.jspdf.jsPDF();
                } else {
                    console.error('jsPDF not found');
                    return;
                }
                var imgWidth = 210; // A4 width in mm
                var pageHeight = 295; // A4 height in mm
                var imgHeight = canvas.height * imgWidth / canvas.width;
                var heightLeft = imgHeight;

                var position = 0;

                pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save('download.pdf');
            }).catch(error => {
                console.error('Error capturing the canvas:', error);
            });
        } else {
            console.error('The table element is not found or not attached to the document.');
        }
    });
  });
</script>



<!-- customized script to display vin data  -->
<script>
$(document).ready(function() {
//   $('#vin-search-button').click(function(event) {
    $("#vinSearchForm").submit(function(event){

        event.preventDefault(); // Prevent the form from submitting traditionally
        const form = $(this)
        const formData = form.serialize(); // Serialize form data for submission
        console.log(formData); // Add this line to verify the serialized data
        
        // csrfToken two ways
        const csrfToken = form.find('[name=csrfmiddlewaretoken]').val(); // Fetch CSRF token from the form
        var csrfToken_alternative = $('#vin-search-button').data('bs-csrf');

        $.ajax({
        type: 'POST',
        url: "{% url 'shops:search_by_vin_or_plate' %}", // URL to your Django view
        data: formData,
        beforeSend: function(xhr) {
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('X-CSRFToken', csrfToken); // Include the CSRF token in the header
        },
        success: function(response) {
            console.log(response);
            // Clear any previous results
            $('#vinDataDisplay').empty();

            // Start building the table
            const table = $('<table>').addClass('table table-responsive table-striped');
            const tbody = $('<tbody>');

            // Iterate over the object, skipping null values
            Object.entries(response).forEach(function([key, value]) {
                if (value !== null) { // Check if value is not null
                // Create a table row with two columns: one for the key and one for the value
                const tr = $('<tr>');
                tr.append($('<td>').text(key));
                tr.append($('<td>').text(value));
                tbody.append(tr);
                }
            });

            // Append tbody to table
            table.append(tbody);

            // Append the table to vinDataDisplay div
            $('#vinDataDisplay').append(table);


        },
        error: function() {
            $('#vinDataDisplay').html('<p>An error has occurred</p>');
        }
        });
    });
    
    $("#PlateSearchForm").submit(function(event){

        event.preventDefault(); // Prevent the form from submitting traditionally
        const form = $(this)
        const formData = form.serialize(); // Serialize form data for submission
        console.log(formData); // Add this line to verify the serialized data
        
        // csrfToken two ways
        const csrfToken = form.find('[name=csrfmiddlewaretoken]').val(); // Fetch CSRF token from the form
        var csrfToken_alternative = $('#plate-search-button').data('bs-csrf');

        $.ajax({
        type: 'POST',
        url: "{% url 'shops:search_by_vin_or_plate' %}", // URL to your Django view
        data: formData,
        beforeSend: function(xhr) {
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('X-CSRFToken', csrfToken); // Include the CSRF token in the header
        },
        success: function(response) {
            console.log(response);
            // Clear any previous results
            $('#vinDataDisplay').empty();

            // Start building the table
            const table = $('<table>').addClass('table table-responsive table-striped');
            const tbody = $('<tbody>');

            // Iterate over the object, skipping null values
            Object.entries(response).forEach(function([key, value]) {
                if (value !== null) { // Check if value is not null
                // Create a table row with two columns: one for the key and one for the value
                const tr = $('<tr>');
                tr.append($('<td>').text(key));
                tr.append($('<td>').text(value));
                tbody.append(tr);
                }
            });

            // Append tbody to table
            table.append(tbody);

            // Append the table to vinDataDisplay div
            $('#vinDataDisplay').append(table);


        },
        error: function() {
            $('#vinDataDisplay').html('<p>An error has occurred</p>');
        }
        });
    });


});
</script>

{% endblock %}