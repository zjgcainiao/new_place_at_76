    <!-- 2023-11-08 added a customer support converation button  -->
    <style>
      .support-button {
        position: fixed;
        bottom: 0;
        right: 0;
        margin: 20px;
        cursor: pointer;
      }
       .support-icon {
        font-size: 30px; /* Size of the icon */
        /* Add additional styling for the icon here */
      }


      .support-window {
        display: none;
        position: fixed;
        bottom: 60px; /* Adjust depending on button size */
        right: 20px;
        border: 2px solid #666; /* More pronounced border */
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        width: 300px; /* Adjust the width as needed */
        z-index: 1000; /* Make sure it floats above other content */
        background-color: linear-gradient(315deg, #DADADA, #fff1f2); /* Background color for the window */
        box-sizing: border-box; /* Box sizing to ensure padding doesn't affect width */
        padding: 15px; /* Padding inside the window */
        /* Additional responsive styles */
        max-width: 90%; /* Max width to ensure it doesn't get too wide on larger screens */
      }
      /* Responsive behavior for smaller screens */
      @media (max-width: 600px) {
        .support-window {
          right: 10px;
          bottom: 50px;
          width: auto; /* Full width on smaller screens */
        }
      }
      .spinner-border-new-conversation {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        vertical-align: text-bottom;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border-new-conversation .75s linear infinite;
      }

      @keyframes spinner-border-new-conversation {
        to { transform: rotate(360deg); }
      }
    </style>

    <div id="loading-spinner-new-conversation" class="spinner-border-new-conversation text-primary" role="status" style="display: none;">
      <span class="sr-only">launching a new customer support conversation</span>
    </div>

    <form method="POST" id="new-support-conversation-form">
      {% csrf_token %}
      <button class="support-button" id="new_conversation_button" type="submit" value="Submit">

          <i class="support-icon fa fa-comments"></i>
    
        </button>
    </form>
  
    <div class="support-window" id="support_conversation_window">
        
    </div>

    <script>
        // Function to handle debounce
      function debounce(func, wait, immediate) {
        var timeout;
        return function() {
          var context = this, args = arguments;
          var later = function() {
            timeout = null;
            if (!immediate) func.apply(context, args);
          };
          var callNow = immediate && !timeout;
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
          if (callNow) func.apply(context, args);
        };
      }

      $(document).ready(function() {
          var debounceTimeout;
          var ajaxCallTimeout;
          var ajaxCallDuration = 10000; // 10 seconds for timeout

          function handleNewConversationClick(event) {
              event.preventDefault();
              var $button = $(this);
              var $spinner = $('#loading-spinner-new-conversation');
              var $form = $('#new-support-conversation-form');
              var csrfToken = $form.find('[name=csrfmiddlewaretoken]').val();

              // Disable the button and show the spinner
              $button.prop('disabled', true);
              $spinner.show();

              // Clear any existing ajax call timeout
              clearTimeout(ajaxCallTimeout);

              // Set a new timeout for the AJAX call
              ajaxCallTimeout = setTimeout(function() {
                console.error('Timeout: Could not get a response from the server.');
                $spinner.hide();
                $button.prop('disabled', false);
              }, ajaxCallDuration);

              $.ajax({
                url: '/crms/new_conversation/',
                type: 'POST',
                data: JSON.stringify({}),
                contentType: 'application/json',
                dataType: 'json',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'X-CSRFToken': csrfToken
                },
                success: function(data) {
                  console.log('Fetch data success. Conversation UUID is: ', data.uuid);
                  if (data.uuid) {
                    renderConversationWindow(data.uuid);
                  }
                },
                error: function(xhr, status, error) {
                  console.error('Error:', error);
                },
                complete: function() {
                  // Clear the ajax call timeout since the call is complete
                  clearTimeout(ajaxCallTimeout);
                  $spinner.hide();
                  $button.prop('disabled', false);
                },
              });
            }
            $('#new_conversation_button').click(debounce(handleNewConversationClick, 300));
          // $('#new_conversation_button').click(function(event) {
          //   event.preventDefault();
          //   $('#loading-spinner-new-conversation').show(); // Show the spinner
          //   var form = $('#new-support-conversation-form');
          //   var csrfToken = form.find('[name=csrfmiddlewaretoken]').val(); // Fetch CSRF token from the form
          //   $.ajax({
          //       url: '/crms/new_conversation/',
          //       type: 'POST',
          //       data: JSON.stringify({}), // If you need to send data
          //       contentType: 'application/json',
          //       dataType: 'json',
          //       headers: {
          //           'X-Requested-With': 'XMLHttpRequest',
          //           'X-CSRFToken': csrfToken // Include the CSRF token in the header
          //       },
          //       success: function(data) {
          //         console.log('fetch data success.conversation uuid is: ', data.uuid);
          //           if (data.uuid) {
          //               conversation_uid = data.uuid;
          //               // Render the conversation window with the received UUID
          //               renderConversationWindow(conversation_uid);
          //           }
          //       },
          //       error: function(xhr, status, error) {
          //           console.error('Error:', error);
          //       },
          //       complete: function() {
          //             $('#loading-spinner').hide(); // Hide the spinner once everything is loaded
          //       },
          //   });
          // });
          // end of .ajax() call 
      });

      function renderConversationWindow(uuid) {

        // Determine if the app is running on localhost
        var isLocalhost = ["localhost", "127.0.0.1"].includes(window.location.hostname);
        var wsProtocol = isLocalhost ? "ws://" : "wss://";
        // Creating the HTML structure
        var conversationHtml = `  
              <div class="card card-hover border-5">
                  <h4 class="card-header text-dark">Customer Support </h4>
                  <p class="text-muted">(ID:${uuid})</p>
                  <div class="card-body">
                      <textarea id="conversation-log" cols="40" rows="10" readonly></textarea><br>
                      <input id="conversation-message-input" type="text" class="form-control mb-3" />
                      <button class="btn btn-outline-dark" id="conversation-message-submit" type="button">Send</button>
                  </div>
              </div>
            `;

        // Append it to the body or a specific element
        $('#support_conversation_window').append(conversationHtml);

        // Make the support conversation window visible
        $('.support-window').css('display', 'block');

        // Establish the WebSocket connection
        // use ws:// when its local server. use wss:// for production server.
        const conversationSocket = new WebSocket(
            wsProtocol + window.location.host + '/ws/conversations/' + uuid + '/'
        );

        // WebSocket event for receiving messages
        conversationSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          const message = data.conversation_message;
          const direction = data.direction;  // 0 for outgoing, 1 for incoming

          let formattedMessage = '';
          if (direction === 0) {
              formattedMessage = 'Operator: ' + message;
          } else {
              formattedMessage = 'Customer: ' + message;
          }

          $('#conversation-log').val(function(index, value) {
              return value + (formattedMessage + '\n');
          });
        };

        conversationSocket.onclose = function(e) {
            console.error('Customer Support Conversation socket was closed unexpectedly.');
        };

        // Send message event
        $(document).on('click', '#conversation-message-submit', function() {
            var messageInput = $('#conversation-message-input');
            var message = messageInput.val();
            // Determine the direction of the message
            // For example, let's assume 1 is for messages from customer to operator
            var messageDirection = 1;
            conversationSocket.send(JSON.stringify({
                'conversation_message': message,
                'message_direction': messageDirection,
            }));
            messageInput.val('');
        });

        // Press Enter to send message
        $('#conversation-message-input').keyup(function(e) {
            if (e.key === 'Enter') {
                $('#conversation-message-submit').click();
            }
        });

        // Focus the input field for message
        $('#conversation-message-input').focus();
      }
  </script>